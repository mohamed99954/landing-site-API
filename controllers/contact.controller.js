const Contact = require('../models/contact.model');
const nodemailer = require('nodemailer');

// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ§ØµÙ„ + Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„
exports.createContact = async (req, res) => {
  try {
    const { name, email, message } = req.body;

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„
    if (!name || !email || !message) {
      return res.status(400).json({ error: 'Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø©' });
    }

    // 1. Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const savedMessage = await Contact.create({ name, email, message });

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¹Ø¨Ø± Gmail Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
    const transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_RECEIVER,
        pass: process.env.EMAIL_PASSWORD
      }
    });

    // 3. Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯
    const mailOptions = {
      from: email,
      to: process.env.EMAIL_RECEIVER,
      subject: 'ğŸ“© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙˆØ§ØµÙ„',
      html: `
        <h2>ğŸ“¬ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${name}</h2>
        <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${email}</p>
        <p><strong>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong></p>
        <p>${message}</p>
      `
    };

    // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯
    await transporter.sendMail(mailOptions);

    res.status(201).json({
      message: 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­',
      data: savedMessage
    });
  } catch (err) {
    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', err.message);
    res.status(500).json({ error: 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©' });
  }
};

// âœ… Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
exports.getAllContacts = async (req, res) => {
  try {
    const contacts = await Contact.find().sort({ createdAt: -1 });
    res.json(contacts);
  } catch (err) {
    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', err.message);
    res.status(500).json({ error: 'âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„' });
  }
};

// âœ… Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© ØªÙˆØ§ØµÙ„ ÙˆØ§Ø­Ø¯Ø©
exports.deleteContact = async (req, res) => {
  try {
    await Contact.findByIdAndDelete(req.params.id);
    res.json({ message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­' });
  } catch (err) {
    console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', err.message);
    res.status(500).json({ error: 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©' });
  }
};